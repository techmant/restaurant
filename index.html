<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Restaurante - Menú</title>
<link rel="stylesheet" href="assets/css/styles.css">
<style>
body{background:#f2f2f2;font-family:sans-serif;margin:0;padding:0;}
.site-header{display:flex;justify-content:space-between;padding:15px;background:#c0392b;color:#fff;align-items:center;}
.btn{cursor:pointer;padding:6px 12px;border:none;border-radius:4px;transition:0.3s;}
.btn.primary{background:#27ae60;color:#fff;}
.btn.primary:hover{background:#2ecc71;}
.btn.small{font-size:14px;}
.menu-area{display:flex;flex-wrap:wrap;justify-content:center;margin:20px;}
.card{background:#fff;border-radius:10px;box-shadow:0 4px 8px rgba(0,0,0,0.1);margin:10px;padding:10px;width:250px;transition:transform 0.3s;}
.card:hover{transform:rotateY(15deg);}
.imgwrap img{width:100%;border-radius:8px;}
.qty-controls{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;}
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:100;}
.modal.hidden{display:none;}
.modal-content{background:#fff;padding:20px;border-radius:10px;width:90%;max-width:400px;}
.cart-item{display:flex;justify-content:space-between;margin:6px 0;}
</style>
</head>
<body>

<header class="site-header">
  <div class="brand">Restaurante</div>
  <div class="header-right">
    <div id="mesaBadge">Mesa: --</div>
    <button id="openCartBtn" class="btn small">Ver Pedido <span id="cartCount">0</span></button>
  </div>
</header>

<main>
  <section id="menuArea" class="menu-area"></section>
</main>

<div id="cartModal" class="modal hidden">
  <div class="modal-content">
    <h3>Tu Pedido</h3>
    <div id="cartItems"></div>
    <input id="note" placeholder="Observaciones"/>
    <div>Total: $<span id="cartTotal">0.00</span></div>
    <button id="placeOrderBtn" class="btn primary">Hacer pedido</button>
    <button id="closeCartBtn" class="btn">Cerrar</button>
  </div>
</div>

<script>
const API_BASE='https://script.google.com/macros/s/AKfycbykvqW5j1KO5WP9VwJITtvjwWx_k1Iu60mtRcmHdqokRepM1mih22LFY9E1a4sO03zD/exec'; // reemplaza con tu URL Web App
let CART={items:[],mesa:'0'};


function detectMesa() {
  const urlParams = new URLSearchParams(window.location.search);
  let mesa = urlParams.get('mesa');
  if (!mesa) {
    const path = window.location.pathname.split('/').filter(Boolean);
    const last = path[path.length-1];
    if (/^\d+$/.test(last)) mesa = last;
  }
  return mesa || '0';
}

CART.mesa = detectMesa();
document.getElementById('mesaBadge').innerText = `Mesa: ${CART.mesa}`;



function updateMesaBadge(){
  CART.mesa=getMesaFromURL();
  document.getElementById('mesaBadge').innerText=`Mesa: ${CART.mesa}`;
}

async function fetchMenu(){
  try{
    const res=await fetch(`${API_BASE}?fn=getMenu`);
    const data=await res.json();
    const area=document.getElementById('menuArea');
    area.innerHTML='';
    if(data && data.menu && data.menu.length){
      data.menu.forEach(item=>{
        const card=document.createElement('div'); card.className='card';
        card.innerHTML=`
          <div class="imgwrap"><img src="${item.image_url||'https://via.placeholder.com/250x150'}" alt="${item.name}"/></div>
          <div><b>${item.name} - $${item.price}</b></div>
          <div>${item.description||''}</div>
          <div class="qty-controls">
            <button class="btn dec">-</button>
            <span class="count">0</span>
            <button class="btn inc">+</button>
            <button class="btn primary add">Añadir</button>
          </div>
        `;
        const countEl=card.querySelector('.count');
        card.querySelector('.inc').addEventListener('click',()=>countEl.innerText=Number(countEl.innerText)+1);
        card.querySelector('.dec').addEventListener('click',()=>countEl.innerText=Math.max(0,Number(countEl.innerText)-1));
        card.querySelector('.add').addEventListener('click',()=>{
          const qty=Number(countEl.innerText);
          if(qty>0){
            const existing=CART.items.find(i=>i.id===item.id);
            if(existing) existing.qty+=qty;
            else CART.items.push({id:item.id,name:item.name,price:Number(item.price),qty});
            updateCartUI(); countEl.innerText='0';
          }
        });
        area.appendChild(card);
      });
    } else area.innerHTML='<p>No hay items disponibles.</p>';
  }catch(err){console.error(err);}
}

function updateCartUI(){
  const count=CART.items.reduce((s,i)=>s+i.qty,0);
  document.getElementById('cartCount').innerText=count;
  const total=CART.items.reduce((s,i)=>s+i.qty*i.price,0);
  document.getElementById('cartTotal').innerText=total.toFixed(2);
}

function openCart(){document.getElementById('cartModal').classList.remove('hidden'); renderCartItems();}
function closeCart(){document.getElementById('cartModal').classList.add('hidden');}
function renderCartItems(){
  const list=document.getElementById('cartItems'); list.innerHTML='';
  if(CART.items.length===0){list.innerHTML='<p>No hay items.</p>'; return;}
  CART.items.forEach(it=>{
    const el=document.createElement('div'); el.className='cart-item';
    el.innerHTML=`${it.name} x ${it.qty} - $${(it.qty*it.price).toFixed(2)}`;
    list.appendChild(el);
  });
}

async function placeOrderHandler(){
  if(CART.items.length===0) return alert('Tu pedido está vacío');
  const note=document.getElementById('note').value||'';
  const payload={fn:'placeOrder',mesa_id:CART.mesa,items:CART.items,total:CART.items.reduce((s,i)=>s+i.qty*i.price,0),note};
  try{
    const res=await fetch(API_BASE,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    const data=await res.json();
    if(data.success){
      alert(`Pedido enviado! ID: ${data.order_id}`);
      CART.items=[]; updateCartUI(); closeCart();
    } else alert('Error al enviar pedido: '+(data.error||'desconocido'));
  }catch(err){console.error(err); alert('Error de conexión al enviar pedido');}
}

document.addEventListener('DOMContentLoaded',()=>{
  updateMesaBadge();
  fetchMenu();
  document.getElementById('openCartBtn').addEventListener('click',openCart);
  document.getElementById('closeCartBtn').addEventListener('click',closeCart);
  document.getElementById('placeOrderBtn').addEventListener('click',placeOrderHandler);
});
</script>
<script src="menu.js" defer></script>

</body>
</html>


