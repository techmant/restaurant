<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Restaurante Profesional</title>

<!-- CSS -->
<link rel="stylesheet" href="assets/css/styles.css">

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;800&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

<style>
body{margin:0;font-family:'Roboto',sans-serif;background:linear-gradient(135deg,#f6d365 0%,#fda085 100%);background-size:400% 400%;animation:gradientBG 15s ease infinite;color:#333;overflow-x:hidden}
#cookSection{display:none;}
#clientSection{display:none;}
</style>
</head>
<body>

<!-- ===== CLIENTE ===== -->
<div id="clientSection">
  <section class="hero">
    <h1>¡Bienvenidos al Restaurante Profesional!</h1>
    <p>Disfruta de una experiencia culinaria única con nuestros platillos gourmet.</p>
  </section>

  <div class="carousel"><div class="carousel-inner" id="carouselInner"></div></div>

  <header class="site-header">
    <div class="brand">Restaurante Profesional</div>
    <div class="header-right">
      <div id="mesaBadge" class="mesa-badge">Mesa: --</div>
      <button id="openCartBtn" class="btn small">Ver Pedido <span id="cartCount">0</span></button>
    </div>
  </header>

  <main class="container"><section id="menuArea" class="menu-area"></section></main>

  <div id="cartModal" class="modal">
    <div class="modal-content">
      <h3>Tu Pedido</h3>
      <div id="cartItems"></div>
      <div class="cart-footer">
        <input id="note" placeholder="Observaciones (p.ej. sin cebolla)">
        <div class="total">Total: $<span id="cartTotal">0.00</span></div>
        <button id="placeOrderBtn" class="btn primary">Hacer pedido</button>
        <button id="closeCartBtn" class="btn">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<!-- ===== COCINA ===== -->
<div id="cookSection">
  <header class="site-header cook-header">
    <div class="brand">Panel Cocinero</div>
    <div>
      <input id="tokenInput" placeholder="Token del cocinero" />
      <button id="unlockBtn" class="btn small">Abrir</button>
      <button id="muteBtn" class="btn small">Silenciar</button>
    </div>
  </header>
  <main class="container cook-container">
    <div id="ordersList" class="orders-list">Introduce token y presiona Abrir...</div>
  </main>
</div>

<script>
const API_BASE = 'https://script.google.com/macros/s/AKfycbwRjyKTpEIAA78HGhZcFXx5oVrhQQZtd39fj1FRE5c-0s80zDt0ABZpDUMNetUtMq9J/exec';
const COOK_TOKEN = 'cocina';

let CART = { items: [], mesa: null };
let VIEW = 'client';

// === Obtener parámetros de URL ===
function getURLParams(){
  const url=new URL(window.location.href);
  return Object.fromEntries(url.searchParams.entries());
}
const params=getURLParams();

// === Mostrar secciones según parámetros ===
if(params.view==="cocina"){
  document.getElementById("cookSection").style.display="block";
  VIEW="cook";
}else{
  document.getElementById("clientSection").style.display="block";
  VIEW="client";
}

// ===== Cliente =====
function getMesaFromURL(){ return params.mesa||'0'; }
function updateMesaBadge(){ CART.mesa=getMesaFromURL(); document.getElementById('mesaBadge').innerText=CART.mesa!=='0'?`Mesa: ${CART.mesa}`:'Mesa: --'; }

async function fetchMenu(){
  try{
    const res = await fetch(`${API_BASE}?fn=getMenu`);
    const data = await res.json();
    if(data && data.menu && data.menu.length) renderMenu(data.menu);
    else document.getElementById('menuArea').innerHTML='<p>No hay items disponibles.</p>';
  }catch(err){ console.error(err); document.getElementById('menuArea').innerHTML='<p>Error al cargar el menú</p>'; }
}

function renderMenu(menu){
  const area=document.getElementById('menuArea'); area.innerHTML='';
  menu.forEach(item=>{
    const card=document.createElement('div'); card.className='card';
    card.innerHTML=`
      <div class="imgwrap"><img src="${item.image_url||'https://via.placeholder.com/280x180'}" alt="${item.name}"></div>
      <div class="title">${item.name} - $${Number(item.price).toFixed(2)}</div>
      <div class="desc">${item.description||''}</div>
      <div class="footer">
        <div class="qty-controls"><button class="dec">-</button><span class="count">0</span><button class="inc">+</button></div>
        <button class="btn primary add">Añadir</button>
      </div>`;
    const countEl=card.querySelector('.count');
    card.querySelector('.inc').addEventListener('click',()=>{ countEl.innerText=Number(countEl.innerText)+1; });
    card.querySelector('.dec').addEventListener('click',()=>{ countEl.innerText=Math.max(0,Number(countEl.innerText)-1); });
    card.querySelector('.add').addEventListener('click',()=>{ const qty=Number(countEl.innerText); if(qty>0){ const ex=CART.items.find(i=>i.id===item.id); if(ex) ex.qty+=qty; else CART.items.push({id:item.id,name:item.name,price:Number(item.price),qty}); updateCartUI(); countEl.innerText='0';}});
    area.appendChild(card);
  });
}

function updateCartUI(){ document.getElementById('cartCount').innerText=CART.items.reduce((s,i)=>s+i.qty,0); document.getElementById('cartTotal').innerText=CART.items.reduce((s,i)=>s+i.qty*i.price,0).toFixed(2);}
function renderCartItems(){ const list=document.getElementById('cartItems'); list.innerHTML=''; if(CART.items.length===0){ list.innerHTML='<p>No hay items.</p>'; return;} CART.items.forEach(it=>{ const el=document.createElement('div'); el.innerHTML=`<div>${it.name} x${it.qty}</div><div>$${(it.qty*it.price).toFixed(2)}</div>`; list.appendChild(el);}); document.getElementById('cartTotal').innerText=CART.items.reduce((s,i)=>s+i.qty*i.price,0).toFixed(2);}
function openCart(){ document.getElementById('cartModal').classList.add('show'); renderCartItems();}
function closeCart(){ document.getElementById('cartModal').classList.remove('show'); }

document.getElementById('openCartBtn')?.addEventListener('click',openCart);
document.getElementById('closeCartBtn')?.addEventListener('click',closeCart);

document.getElementById('placeOrderBtn')?.addEventListener('click',async()=>{
  if(CART.items.length===0) return alert('Tu pedido está vacío');
  const note=document.getElementById('note').value||'';
  const payload={ fn:'placeOrder', mesa_id:CART.mesa||'0', items:CART.items, total:CART.items.reduce((s,i)=>s+i.qty*i.price,0), note};
  try{
    const res=await fetch(API_BASE,{ method:'POST', headers:{'Content-Type':'text/plain'}, body:JSON.stringify(payload)});
    const data=await res.json();
    if(data.success){ alert(`Pedido enviado. ID: ${data.order_id}`); CART.items=[]; updateCartUI(); closeCart(); document.getElementById('note').value=''; }
    else alert('Error al enviar pedido');
  }catch(err){ console.error(err); alert('Error de conexión');}
});

// ===== Cocina =====
function unlockCook(){
  const token=document.getElementById('tokenInput').value;
  if(token===COOK_TOKEN){ loadOrders(); setInterval(loadOrders,5000); }
  else alert('Token incorrecto');
}
document.getElementById('unlockBtn')?.addEventListener('click',unlockCook);

async function loadOrders(){
  if(VIEW!=='cook') return;
  try{
    const res=await fetch(`${API_BASE}?fn=getOrders`);
    const data=await res.json();
    const cont=document.getElementById('ordersList'); cont.innerHTML='';
    if(data.orders && data.orders.length){
      data.orders.forEach(o=>{
        const div=document.createElement('div');
        const items=(o.items||[]).map(i=>`${i.name} x${i.qty}`).join(', ');
        div.innerHTML=`<strong>Mesa ${o.mesa_id}</strong>: ${items}<br>Nota: ${o.note||''}`;
        cont.appendChild(div);
      });
    } else cont.innerHTML='No hay pedidos';
  }catch(err){ console.error(err); document.getElementById('ordersList').innerHTML='Error al cargar pedidos';}
}

// === Inicializar ===
if(VIEW==='client'){ updateMesaBadge(); fetchMenu(); }
</script>

</body>
</html>
