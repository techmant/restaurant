<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Restaurante Profesional</title>

<!-- CSS propio -->
<link rel="stylesheet" href="assets/css/styles.css">

<!-- Google Material Chips -->
<link rel="stylesheet" href="https://unpkg.com/@material/chips/dist/mdc.chips.css">
<script src="https://unpkg.com/@material/chips/dist/mdc.chips.min.js" defer></script>

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;800&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

<style>
/* Tus estilos actuales se mantienen tal cual del index.html */
body{margin:0;font-family:'Roboto',sans-serif;background:linear-gradient(135deg,#f6d365 0%,#fda085 100%);background-size:400% 400%;animation:gradientBG 15s ease infinite;color:#333;overflow-x:hidden}
/* ... resto de tus estilos index.html ... */
#cookSection{display:none;}
</style>
</head>
<body>

<!-- ===== CLIENTE ===== -->
<div id="clientSection">
  <!-- Hero -->
  <section class="hero">
    <h1>¡Bienvenidos al Restaurante Profesional!</h1>
    <p>Disfruta de una experiencia culinaria única con nuestros platillos gourmet, preparados con ingredientes frescos y recetas exclusivas. ¡Tu mesa te espera!</p>
  </section>

  <!-- Carousel -->
  <div class="carousel">
    <div class="carousel-inner" id="carouselInner"></div>
  </div>

  <header class="site-header">
    <div class="brand">Restaurante Profesional</div>
    <div class="header-right">
      <div id="mesaBadge" class="mesa-badge">Mesa: --</div>
      <button id="openCartBtn" class="btn small">Ver Pedido <span id="cartCount">0</span></button>
    </div>
  </header>

  <main class="container">
    <section id="menuArea" class="menu-area"></section>
  </main>

  <!-- Carrito modal -->
  <div id="cartModal" class="modal">
    <div class="modal-content">
      <h3>Tu Pedido</h3>
      <div id="cartItems"></div>
      <div class="cart-footer">
        <input id="note" placeholder="Observaciones (p.ej. sin cebolla)">
        <div class="total">Total: $<span id="cartTotal">0.00</span></div>
        <button id="placeOrderBtn" class="btn primary">Hacer pedido</button>
        <button id="closeCartBtn" class="btn">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<!-- ===== COCINA ===== -->
<div id="cookSection">
  <header class="site-header cook-header">
    <div class="brand">Panel Cocinero</div>
    <div>
      <input id="tokenInput" placeholder="Token del cocinero" />
      <button id="unlockBtn" class="btn small">Abrir</button>
      <button id="muteBtn" class="btn small">Silenciar</button>
    </div>
  </header>
  <main class="container cook-container">
    <div id="ordersList" class="orders-list">Introduce token y presiona Abrir...</div>
  </main>
</div>

<script>
const API_BASE = 'https://script.google.com/macros/s/AKfycbwRjyKTpEIAA78HGhZcFXx5oVrhQQZtd39fj1FRE5c-0s80zDt0ABZpDUMNetUtMq9J/exec';
const COOK_TOKEN = 'cocina'; // token secreto

let CART = { items: [], mesa: null };
let VIEW = 'client'; // client o cook

// ===== Cliente =====
const carouselImages = [
  'https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?ixlib=rb-4.0.3&auto=format&fit=crop&w=1350&q=80',
  'https://images.unsplash.com/photo-1504674900247-0877df9cc836?ixlib=rb-4.0.3&auto=format&fit=crop&w=1350&q=80',
  'https://images.unsplash.com/photo-1550966871-3ed3cdb5ed0c?ixlib=rb-4.0.3&auto=format&fit=crop&w=1350&q=80'
];

function initCarousel() {
  const inner = document.getElementById('carouselInner');
  carouselImages.forEach(src => {
    const item = document.createElement('div');
    item.className = 'carousel-item';
    item.style.backgroundImage = `url(${src})`;
    inner.appendChild(item);
  });
  let index=0; const items=inner.children;
  if(items.length>0) items[0].classList.add('active');
  setInterval(()=>{ items[index].classList.remove('active'); index=(index+1)%items.length; items[index].classList.add('active'); },4000);
}

function getMesaFromURL(){ const url=new URL(window.location.href); return url.searchParams.get('mesa')||url.pathname.split('/').pop()||'0'; }
function updateMesaBadge(){ CART.mesa=getMesaFromURL(); document.getElementById('mesaBadge').innerText=CART.mesa!=='0'?`Mesa: ${CART.mesa}`:'Mesa: --'; }

async function fetchMenu(){
  try{
    const res = await fetch(`${API_BASE}?fn=getMenu`);
    const data = await res.json();
    if(data && data.menu && data.menu.length) renderMenu(data.menu);
    else document.getElementById('menuArea').innerHTML='<p>No hay items disponibles.</p>';
  }catch(err){ console.error(err); document.getElementById('menuArea').innerHTML='<p>Error al cargar el menú</p>'; }
}

function renderMenu(menu){
  const area=document.getElementById('menuArea'); area.innerHTML='';
  menu.forEach(item=>{
    const cardWrapper=document.createElement('div'); cardWrapper.className='card';
    const inner=document.createElement('div'); inner.className='card-inner';
    inner.innerHTML=`
      <div class="imgwrap"><img src="${item.image_url||'https://via.placeholder.com/280x180'}" alt="${item.name}"></div>
      <div class="title">${item.name} - $${item.price.toFixed(2)}</div>
      <div class="desc">${item.description||'Delicioso platillo'}</div>
      <div class="footer">
        <div class="qty-controls"><button class="dec">-</button><span class="count">0</span><button class="inc">+</button></div>
        <button class="btn primary add">Añadir</button>
      </div>`;
    const countEl = inner.querySelector('.count');
    inner.querySelector('.inc').addEventListener('click',()=>{ countEl.innerText=Number(countEl.innerText)+1; });
    inner.querySelector('.dec').addEventListener('click',()=>{ countEl.innerText=Math.max(0,Number(countEl.innerText)-1); });
    inner.querySelector('.add').addEventListener('click',()=>{
      const qty=Number(countEl.innerText);
      if(qty>0){ const existing=CART.items.find(i=>i.id===item.id); if(existing) existing.qty+=qty; else CART.items.push({id:item.id,name:item.name,price:Number(item.price),qty}); updateCartUI(); countEl.innerText='0'; inner.style.transform='scale(0.95)'; setTimeout(()=>{inner.style.transform='';},150);}
    });
    cardWrapper.appendChild(inner); area.appendChild(cardWrapper);
  });
}

function updateCartUI(){ document.getElementById('cartCount').innerText=CART.items.reduce((s,i)=>s+i.qty,0); document.getElementById('cartTotal').innerText=CART.items.reduce((s,i)=>s+i.qty*i.price,0).toFixed(2);}
function renderCartItems(){ const list=document.getElementById('cartItems'); list.innerHTML=''; if(CART.items.length===0){ list.innerHTML='<p style="text-align:center;color:#888;font-style:italic;">No hay items en tu pedido.</p>'; return;} CART.items.forEach(it=>{ const el=document.createElement('div'); el.style.display='flex'; el.style.justifyContent='space-between'; el.style.margin='12px 0'; el.style.padding='10px'; el.style.background='#fff9f5'; el.style.borderRadius='10px'; el.style.boxShadow='0 2px 5px rgba(0,0,0,0.05)'; el.innerHTML=`<div><b>${it.name}</b> x ${it.qty}</div><div>$${(it.qty*it.price).toFixed(2)}</div>`; list.appendChild(el);}); document.getElementById('cartTotal').innerText=CART.items.reduce((s,i)=>s+i.qty*i.price,0).toFixed(2);}
function openCart(){ document.getElementById('cartModal').classList.add('show'); renderCartItems();}
function closeCart(){ document.getElementById('cartModal').classList.remove('show'); }

document.getElementById('openCartBtn').addEventListener('click', openCart);
document.getElementById('closeCartBtn').addEventListener('click', closeCart);

document.getElementById('placeOrderBtn').addEventListener('click', async()=>{
  if(CART.items.length===0) return alert('Tu pedido está vacío');
  const note=document.getElementById('note').value||'';
  const payload={ fn:'placeOrder', mesa_id:CART.mesa||'0', items:CART.items, total:CART.items.reduce((s,i)=>s+i.qty*i.price,0), note};
  try{
    const res=await fetch(API_BASE,{ method:'POST', headers:{'Content-Type':'text/plain'}, body:JSON.stringify(payload)});
    const data=await res.json();
    if(data && data.success){ alert(`¡Pedido enviado con éxito! ID: ${data.order_id}`); CART.items=[]; updateCartUI(); closeCart(); document.getElementById('note').value=''; }
    else alert('Error al enviar pedido');
  }catch(err){ console.error(err); alert('Error de conexión al enviar pedido');}
});

// ===== Cocina =====
function unlockCook(){ const token=document.getElementById('tokenInput').value; if(token===COOK_TOKEN){ VIEW='cook'; document.getElementById('clientSection').style.display='none'; document.getElementById('cookSection').style.display='block'; loadOrders(); setInterval(loadOrders,5000);} else alert('Token incorrecto'); }
document.getElementById('unlockBtn').addEventListener('click',unlockCook);

async function loadOrders(){
  if(VIEW!=='cook') return;
  try{
    const res = await fetch(`${API_BASE}?fn=getOrders`);
    const data = await res.json();
    const container=document.getElementById('ordersList'); container.innerHTML='';
    if(data.orders && data.orders.length){
      data.orders.forEach(o=>{
        const div=document.createElement('div');
        div.innerHTML=`<strong>Mesa ${o.mesa}</strong>: ${o.items.map(i=>i.name+' x'+i.qty).join(', ')} <br>Nota: ${o.note}`;
        container.appendChild(div);
      });
    } else container.innerHTML='No hay pedidos';
  } catch(err){ console.error(err); document.getElementById('ordersList').innerHTML='Error al cargar pedidos'; }
}

// ===== Inicializar =====
updateMesaBadge();
fetchMenu();
initCarousel();
</script>

</body>
</html>
